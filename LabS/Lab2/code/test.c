#include <stdio.h>
#include <windows.h>
char *s="I'm hacked!";
//实验1的内容
/*char code[] = {	0x6A, 0x00, 
								0x68, 0x00, 0x80, 0x40, 0x00,
								0x68, 0x00, 0x80, 0x40, 0x00,
								0x6A, 0x00,
								0xFF, 0x15,0xE0,0x60,0x40,0x00,//ff15作为call需要一个跳板，后面的地址对应的内存单元存储着我们需要的地址
								0xC3};
*/

//实验2的内容
char code[]={ 	
					0x55,
					0x8b,0xec,
					0x83,0xec,0x30,
					0xc6,0x45,0xd1,0x49,
					0xc6,0x45,0xd2,0x27,
					0xc6,0x45,0xd3,0x60,
					0xc6,0x45,0xd4,0x20,
					0xc6,0x45,0xd5,0x68,
					0xc6,0x45,0xd6,0x61,
					0xc6,0x45,0xd7,0x63,
					0xc6,0x45,0xd8,0x6b,
					0xc6,0x45,0xd9,0x65,
					0xc6,0x45,0xda,0x64,
					0xc6,0x45,0xdb,0x21,
					0xc6,0x45,0xdc,0x00,
					0x6a,0x00,
					0x8d,0x45,0xd1,
					0x50,
					0x50,
					0x6a,0x00,
					0xff,0x15,0xe0,0x60,0x40,0x00,
					0x83,0xc4,0x30,
					0x8b,0xe5,
					0x5d,
					0xc3};
void main()
{
    int old;
    int h=0,f=0,i,flag;
    PBYTE smaddr;
    flag=VirtualProtect(&code[0], sizeof(code), PAGE_EXECUTE_READWRITE, &old);
    printf("%d\n",flag);
   
    h=LoadLibraryA("user32.dll");
    f=GetProcAddress(h,"MessageBoxA");

    smaddr=f;
    
    //printf("ShowMsgAddr:%08x",smaddr);
    
    
    //实验1内容
    
    __asm{
    			
    			mov ebx,offset code
    			/*mov eax,[s]
          mov [ebx+0x3],eax
          mov eax,[s]
          mov [ebx+0x8],eax*/
          lea eax,smaddr
         // mov [ebx+0x10],eax//实验1
          mov [ebx+0x41],eax //实验2
    	}
    	
    /*for(i=0;i<20;i++){
    	if(i%5==0) printf("\n");
    	printf("%02x ",code[i]);
    	}*/
    	
    __asm {
    	  
       call  offset code
       //add 	esp,0x4	
    }
     return;
   
} 